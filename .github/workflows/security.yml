name: security

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Mondays 06:00 UTC

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  cargo_audit:
    name: cargo audit (RustSec)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Cargo audit
        uses: actions-rust-lang/audit@v1
        with:
          # Keep PR checks non-invasive: no automatic GitHub issue creation.
          createIssues: false
          # Use repo config (.cargo/audit.toml) and Cargo.lock by default.
          TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy_images:
    name: trivy (local docker images)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build adapter image (local)
        run: docker build -t local/unrelated-mcp-adapter:pr .

      - name: Build gateway runtime image (local)
        run: docker build --target gateway-runtime -t local/unrelated-mcp-gateway:pr .

      - name: Build gateway migrator image (local)
        run: docker build --target gateway-migrator -t local/unrelated-mcp-gateway-migrator:pr .

      - name: Build gateway UI image (local)
        run: docker build -f ui/Dockerfile -t local/unrelated-mcp-gateway-ui:pr ui

      - name: Trivy scan (adapter)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: local/unrelated-mcp-adapter:pr
          format: table
          exit-code: "1"
          vuln-type: os,library
          severity: CRITICAL,HIGH

      - name: Trivy scan (gateway)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: local/unrelated-mcp-gateway:pr
          format: table
          exit-code: "1"
          vuln-type: os,library
          severity: CRITICAL,HIGH

      - name: Trivy scan (gateway migrator)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: local/unrelated-mcp-gateway-migrator:pr
          format: table
          exit-code: "1"
          vuln-type: os,library
          severity: CRITICAL,HIGH

      - name: Trivy scan (gateway UI)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: local/unrelated-mcp-gateway-ui:pr
          format: table
          exit-code: "1"
          vuln-type: os,library
          severity: CRITICAL,HIGH
